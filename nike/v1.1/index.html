<html>
  <head>
    <meta http-Equiv="Cache-Control" Content="no-cache" />
    <meta http-Equiv="Pragma" Content="no-cache" />
    <meta http-Equiv="Expires" Content="0" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <script type="text/javascript" src="sdk.js"></script>
  <head>

  <body>

    <h2>Nike VoC</h2>

    <script>
      Centricient.init('https://bill.dev.centricient.corp');

      defineJson();

      var extensionData = Centricient.getExtensionData();
      if(extensionData) {
        populateLink(window.JSON.parse(extensionData));
      }

      Centricient.on('extensionDataChanged', function(data){
        if(!data || !data.data){
          alert('data is null');
        }

        alert(window.JSON);

        var json2 = window.JSON.parse(data.data);
        populateLink(json2);
      });

      function populateLink(data){
        console.debug(data);
        var link = 'http://survey.medallia.com/nikecs-sms?athlete='+encodeURIComponent(data.Login.toUpperCase())+'&refid='+encodeURIComponent(data.Refno);
        console.debug(link);
        var message = 'Thank you for choosing Nike. We value your feedback: ' + link;
        Centricient.sendOnClose(message);
        document.getElementById('cent-notice').innerHTML =
          '<h3>VoC link ready</h3>The following message will be sent to the consumer when the conversation is closed:<p>' + message + '</p>';
      }


      function defineJson(){
        if (!window.JSON) {
 window.JSON = {
   parse: function(sJSON) { return eval('(' + sJSON + ')'); },
   stringify: (function () {
     var toString = Object.prototype.toString;
     var isArray = Array.isArray || function (a) { return toString.call(a) === '[object Array]'; };
     var escMap = {'"': '\\"', '\\': '\\\\', '\b': '\\b', '\f': '\\f', '\n': '\\n', '\r': '\\r', '\t': '\\t'};
     var escFunc = function (m) { return escMap[m] || '\\u' + (m.charCodeAt(0) + 0x10000).toString(16).substr(1); };
     var escRE = /[\\"\u0000-\u001F\u2028\u2029]/g;
     return function stringify(value) {
       if (value == null) {
         return 'null';
       } else if (typeof value === 'number') {
         return isFinite(value) ? value.toString() : 'null';
       } else if (typeof value === 'boolean') {
         return value.toString();
       } else if (typeof value === 'object') {
         if (typeof value.toJSON === 'function') {
           return stringify(value.toJSON());
         } else if (isArray(value)) {
           var res = '[';
           for (var i = 0; i < value.length; i++)
             res += (i ? ', ' : '') + stringify(value[i]);
           return res + ']';
         } else if (toString.call(value) === '[object Object]') {
           var tmp = [];
           for (var k in value) {
             if (value.hasOwnProperty(k))
               tmp.push(stringify(k) + ': ' + stringify(value[k]));
           }
           return '{' + tmp.join(', ') + '}';
         }
       }
       return '"' + value.toString().replace(escRE, escFunc) + '"';
     };
   })()
 };
}
      }

    </script>

    <div id='cent-notice'>
    </div>

  </body>

</html>
